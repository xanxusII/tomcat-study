/**
 * 
 *
 * =========================================================================================================================================================
 * ||                                                                       BQB    BBs                                                                    || 
 * ||                                                                     BBQBQB  QBQBQ                                                                   || 
 * ||                                                                      QBBBBBQBQBB                                                                    || 
 * ||                                 BBQBQ                                  BQBQBQB                                  QBBBQ                               || 
 * ||                                QBQBBBQ                                  BQBBB                                  BBBBBBB                              || 
 * ||                                  BQBBB                                  BBQBB                                  BBBBBB                               || 
 * ||                                  QBQBB                                  BQBBB                                  BBBBB   B                            || 
 * ||                            BBBQBBBQBBBQB                                BBQBQ                                BQBQBQBBBQBBB                          || 
 * ||                            BBQBBBBBBBQBQBB                              BQBBB                              BBBBBBQBQBQBQBQ                          || 
 * ||                             QBBB   BBBQBQBBBQ                           BBBBB                            BBBQBBBBB    BBQ                           || 
 * ||                                      BBBBQBBBQB                                                       BBBBBBBQBQ                                    || 
 * ||                                         QBQBQBBBB                     QBiBBBQrQ                     QBQBQBQBQB                                      || 
 * ||                                           BBBQBQBBBQ              BQBBBQBQBQBBBBBQBQ              BBBBBBBBB                                         || 
 * ||                                                     BB         BQBQBQBBBBBQBQBBBQBBBBB         BQ                                                   || 
 * ||                                             BQBQ       B     BBBBBBQBQBQBBBBBQBBBBBBBBBQ     Q       gBBBg                                          || 
 * ||                                      BQBBBBBBBQBQBBBQ      BQBBBQBBBBBQBBBBBQBQBBBQBBBBBBB      BBBBBBBBBBBBBBBB                                    || 
 * ||                                   BBBQBBBBBBBBBQBBBQBBBQ  BQBBBQBBBBBBBBBQBBBBBQBQBBBBBQBBB   BQBQBBBBBQBBBBBQBBBBB                                 || 
 * ||                                 BBQBQBBBBBQBBBBBQBBBQBB  BQBBBBBBBBBQBQBBBQBBBBBQBBBQBQBQBQB  QBQBBBQBBBQBBBQBBBBBQBB                               || 
 * ||                                BBBBQBBBBBBBBBQBBBQBBBQB  BBQBBBBBQBQBBBQBBBBBBBBBBBQBQBBBBBBB  QBBBQBQBBBBBBBBBBBQBBBQ                              || 
 * ||                               BBQBQBQBBBBBQBQBBBQBQBQB  BBBBBBQBBBQBQBQBBBQBQBBBQBBBQBBBBBBBB  BQBQBQBBBBBQBQBQBQBBBQBQB                            || 
 * ||                              QBBBQBBBQBBBBBBBQBQBBBBBB  BBBB   BBQBQBQBQBBBBBBBBBBBBBQB  QBQB  QBBBQBBBBBQBBBBBBBQBBBBBBB                           || 
 * ||        BQB                  QBQBBBQBBBBBBBQBBBQBQBBBBB  QBQB    QBBBBBQB  B  BBBQBQBQ    QQBQB  QBBBBBBBBBBBBBBBBBQBQBBBQ                  BQBB     || 
 * ||      QBBBBB                 BQBQBQBBBBBBBBBQ   BBBBQBB  BQBB       BBBBQ     BBBBQ        BBBB  BQBBBBB  QBBBBBQBQBQBBBQBQ                BBBBBQ    || 
 * ||       BBQBBBQBBBBBBBQBBBBB BBBBBQBQBBBBBQBQ     QBBBBB  QBBB              Q              BBBBQ QQBQBQB    BBQBQBBBQBQBBBQB  BBBBQBQBBBQBBBBBBBQ     || 
 * ||          BBQBQBBBQBBBQBBB  BBQBBBBBBBQBQBQ      BBBQBB  BQBQB             B             MQBBB  BBBBQBQ     7BQBBBBBQBQBBBB  BBBQBBBBBBBQBQBQ:       || 
 * ||         QBQBBBBBBBQBQBBBQ  BBBQBQBBBBBBB       BBBQBQBB  BBBQBQ         BBQBB         QBBBQB   BBBQBBB       BQBBBBBBBBBBB  BBQBBBBBBBQBBBBBB       || 
 * ||       BQBBB                QBQBQBBBQBQ        BBBBBBBQB   BBBBBQBBBBBQBB     BBBBQBBBBBBBBB   BBBQBBBBBQ       QBBBBBQBQBQ                BBBQBB    || 
 * ||       QBQB                 BB  B  BB       BQBBBQBBBQBQB    BBQBBBBBBBBB     BQBQBBBBBQBB    BBBBBQBBBBBQB       BQB    QB                 BBBQ     || 
 * ||                                         BQBBBQBQBQBBBBBQB      QBQBBBQBBBB  BBBBBBBBBQ      BQBBBQBBBBBQBBBQB                                       || 
 * ||                                 B    BQBQBBBQBQBBBBBBB     B     BQBQ QBBBBBBBQ QBBB     B     BQBBBBBBBQBBBQBQB    B                               || 
 * ||                                 B BBBQBBBQBBBBBBBBBg     BBBBB   BBQ  BBBB  BBB  QBQr  BBQBBB     BBBQBQBBBBBQBBBBB B                               || 
 * ||                               BB    QBQBQBBBBBQBQ     BBBBBBQB  BBQB  BBBB  BBBB  BBQB  QBQBBBQ      BBBQBQBBBQBQ    BB                             || 
 * ||                                     BQBBBQBQBBBBB   BBBBBBBQB        BBBBQ  BQBQ        BBBQBBBBBB   QBBBQBQBQBBB                                   || 
 * ||                                   QBBBBBQBQBB  BQB  QBBBQBQ                               BBBBQBB  BQBB  BBBBBQBBBB                                 || 
 * ||                                    Q  BB  BQB  BB    QBQB                                    QBQB   BB  BBB  QBB Q                                  || 
 * ||                                   B  1QB  BBQ      BBB                  BBBBQ                  BBB      QBQ  BQB  B                                 || 
 * ||                                   B  S           BBB                    BBBQB                    QBQj             B                                 || 
 * ||                                              BQBBB                      QBBBQ                      BQBBB                                            || 
 * ||                                       BBBQBBBQB                         BQBBB                         BQBBBBBBB                                     || 
 * ||                              BB    BBBQBBBBBQ                           BBQBB                           BBBBBBQBQB     B                            || 
 * ||                            QBBBBBQBQBBBBBQB                             BQBBB                             BQBQBBBQBBBQBBBQ                          || 
 * ||                            BQBBBQBBBBBBB                                BBQBQ                                BQBBBQBBBQBBB                          || 
 * ||                             jQB  BBBBB                                  BBBBB                                  BBQBB  BBB                           || 
 * ||                                  BQBB                                   QBBBB                                   QBBB                                || 
 * ||                                BBQBQBB                                  BBBBB                                   BQBBBB                              || 
 * ||                                 BBBBB                                   QBQBBB                                  BBQBB                               || 
 * ||                                                                      BBBBQBQBQBQ                                                                    || 
 * ||                                                                     BBQBQB BBBQBB                                                                   || 
 * ||                                                                      QBQB   BQBQ                                                                    || 
 * =========================================================================================================================================================
 * =========================================================================================================================================================	
 *                                                                         人的梦想是不会结束的！
 *  @作者: xanxus
 *  
 *  @创建时间: 2019年7月3日 下午10:02:52
 *  
 *  @描述: TODO
 *
 *                                                   
 * =========================================================================================================================================================  
 *
 *
 */
package com.xanxus.tomcat.stage01;

import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

/**
 *
 * @作者: xanxus
 *
 * @创建时间: 2019年7月3日 下午10:02:52
 * 
 * @功能描述: request
 *
 * @版本：V1.0 
 *
 */
public class Request {
	
	//================================================================Fields
	
	//从socket中获取的输入流
	private BufferedReader  br;
	// input : input输入
	private InputStream input;
	// requestLine : 请求行
	private RequestLine requestLine;
	
	// length : 缓冲长度
	private int length =  4;
	// buffers : 缓冲,存储请求行和请求头
	private byte[] buffers = new byte[length];
	//请求头
	private Map<String, List<String>>  requestHeaders = new HashMap<>();
	//请求参数 暂时value全部按照String类型处理
	private Map<String, String> requestParemeters = new HashMap<>();
	
	//===============================================================Constructors
	
	public Request(InputStream input){
		this.input = input;
		//this.br = new BufferedReader(new InputStreamReader(input));
		this.requestLine = new RequestLine();
	}
	
	//================================================================method
	
	/** 
	 * @功能描述:	解析socket输入流中的数据
	 *
	 * @参数说明:	
	 *          
	 * @返回值:	void
	 *
	 * @作者:	xanxus
	 *
	 * @创建时间:	2019年7月4日 
	 */  
	public void parse(){
		//开始解析
		System.out.println("开始解析......");
		int len = -1;
		int pos = 0;
		try {
			//获取输入流中的数据读取到buffers字节数组中，如果数组字节长度不够，就扩容2倍。
			while((len = input.read(buffers, pos, length - pos)) != -1){
				pos += len;
				if(buffers[pos - 1] == '\n'
						&& buffers[pos - 2] == '\r' 
						&& buffers[pos - 3] == '\n' 
						&& buffers[pos -4] == '\r')break;
				if(pos < length)continue; 
				byte[] temp = new byte[buffers.length * 2];
				System.arraycopy(buffers, 0, temp, 0, length);
				length = temp.length;
				buffers = temp;
			}
			
			ByteArrayInputStream bis = new ByteArrayInputStream(buffers, 0, pos);
			br = new BufferedReader(new InputStreamReader(bis));
		} catch (IOException e) {

			e.printStackTrace();
		}
		parseRequestLine();
		parseRequestHeader();
		System.out.println("解析结束......");
		Set<Entry<String, List<String>>> set = requestHeaders.entrySet();
		for(Entry<String, List<String>> entry : set){
			System.out.println(entry.getKey() + ":" + entry.getValue());
		}
	}
	
	/** 
	 * @功能描述:	解析请求行的数据，即buffers中第一行的数据
	 *
	 * @参数说明:	
	 *          
	 * @返回值:	void
	 *
	 * @作者:	xanxus
	 *
	 * @创建时间:	2019年7月4日 
	 */  
	public void parseRequestLine(){
		String requestLineStr = null;
		try {
			if(br.ready()){
				requestLineStr = br.readLine();
				if(requestLine == null || "".equals(requestLine))return;
				String[] params = requestLineStr.split(" ");
				if(params.length < 3)return;
				requestLine.setMethod(params[0]);
				requestLine.setUrl(params[1]);
				requestLine.setProtrol(params[2]);
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
	/** 
	 * @功能描述:	解析请求体中的内容
	 *
	 * @参数说明:	
	 *          
	 * @返回值:	void
	 *
	 * @作者:	xanxus
	 *
	 * @创建时间:	2019年7月4日 
	 */  
	public void parseRequestHeader(){
		try {
			while(br.ready()){
				String str = br.readLine();
				if(str == null || "".equals(str.trim()))break;
				String[] params =  str.split(":");
				if(params.length < 2)continue;
				String key = params[0];
				String[] values = params[1].split(";");
				requestHeaders.put(key, Arrays.asList(values));
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
		

		
	}
	
	public void parserRequestBody(){
	}
}
